---
title: "BEFTA bird analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(FD)
library(lme4)
library(gridExtra)
#test commit
```

## R Markdown

Load data.
Note: all data and code available at https://github.com/grahamprescott/befta.birds

```{r cars}
birds.full <- read_csv("./BEFTA birds 2013-2019 final 12.06.2020.csv")
```

Structure

```{r pressure, echo=FALSE}
str(birds.full)
```

Tidy data to make sure common names are internally consistent, and consistent with functional trait dataset. Going to join datasets by common English names. Keeping the correct Latin name for Japanese tit (Parus minor) but giving it the common name 'Great Tit' for convenience in functional analysis. Check this is corrected latr. 

```{r}
birds.full %>%
  mutate(common = str_replace_all(common, c("Cinereous Tit" = "Great Tit",
                                            "Plaintive cuckoo" = "Plaintive Cuckoo",
                                            "Sunda Pied Fantail" = "Pied Fantail",
                                            "Black-naped oriole" = "Black-naped Oriole",
                                            "Pin-striped Tit-Babbler" = "Pin-striped Tit-babbler",
                                            "Striped Tit Babbler" = "Pin-striped Tit-babbler",
                                            "Pied fantail" = "Pied Fantail",
                                            "Barn swallow" = "Barn Swallow",
                                            "Edible-nest swiftlet" = "Edible-nest Swiftlet",
                                            "Slender-billed crow" = "Slender-billed Crow",
                                            "Oriental Magpie-Robin" = "Oriental Mapgie-robin",
                                            "White-breasted Kingfisher" = "White-throated Kingfisher"))) %>%
  mutate(latin = str_replace_all(latin, c("Parus cinereus" = "Parus minor",
                                          "Macronus gularis" = "Mixornis gularis"))) %>%
  
  subset(uncertain == 0) %>%
  group_by(family, latin, common) %>%
  count(sort=TRUE) %>%
  view()
```

Adjust dataset

```{r}
birds.adjusted <- birds.full %>%
  mutate(common = str_replace_all(common, c("Cinereous Tit" = "Great Tit",
                                            "Plaintive cuckoo" = "Plaintive Cuckoo",
                                            "Sunda Pied Fantail" = "Pied Fantail",
                                            "Black-naped oriole" = "Black-naped Oriole",
                                            "Pin-striped Tit-Babbler" = "Pin-striped Tit-babbler",
                                            "Striped Tit Babbler" = "Pin-striped Tit-babbler",
                                            "Pied fantail" = "Pied Fantail",
                                            "Barn swallow" = "Barn Swallow",
                                            "Edible-nest swiftlet" = "Edible-nest Swiftlet",
                                            "Slender-billed crow" = "Slender-billed Crow",
                                            "Oriental Magpie-Robin" = "Oriental Mapgie-robin",
                                            "White-breasted Kingfisher" = "White-throated Kingfisher"))) %>%
  mutate(latin = str_replace_all(latin, c("Parus cinereus" = "Parus minor",
                                          "Macronus gularis" = "Mixornis gularis")))
```



Check uncertain records (tiny fraction)

```{r}
birds.full %>%
  subset(uncertain != 0) %>%
  view()
```

Create 'birds.core' for the core plot analysis

```{r}
birds.core <- birds.adjusted %>%
  # remove flyovers and observations > 70 m [to only include records in core plot]
  subset(distance < 30) %>%
  # remove records of uncertain ID [doubtful records, those marked 'Unidentified', Sunda frogmouth etc had value of 1 in 'uncertain' column]
  subset(uncertain == 0) %>%
  # remove red junglefowl / domestic chicken
  subset(common != "Red Junglefowl") %>%
  #remove Eurasian tree sparrow
  subset(common != "Eurasian Tree Sparrow") %>%
  # remove Oriental Mapgie Robin (poaching pressure biases results)
  subset(common != "Oriental Magpie-robin") %>%
  # remove Sunda Frogmout (nocturnal birds not adequately sampled)
  subset(common != "Sunda Frogmouth")
```


Create the same but with bulbuls lumped

```{r}
birds.core.bulbul.lump <- birds.adjusted %>%
  # remove flyovers and observations > 70 m [to only include records in core plot]
  subset(distance < 30) %>%
  # remove records of uncertain ID [doubtful records, those marked 'Unidentified', Sunda frogmouth etc had value of 1 in 'uncertain' column]
  subset(uncertain == 0) %>%
  # remove red junglefowl / domestic chicken
  subset(common != "Red Junglefowl") %>%
  #remove Eurasian tree sparrow
  subset(common != "Eurasian Tree Sparrow") %>%
  # remove Oriental Mapgie Robin (poaching pressure biases results)
  subset(common != "Oriental Magpie-robin") %>%
  # remove Sunda Frogmout (nocturnal birds not adequately sampled)
  subset(common != "Sunda Frogmouth") %>%
  # merge the bulbuls together into one species; rename Cinereous to Japanese Tit (following recent paper)
  mutate(common = str_replace_all(common, c("Olive-winged Bulbul" = "Bulbul","Yellow-vented Bulbul" = "Bulbul", "Sooty-headed Bulbul" = "Bulbul","Cinereous Tit" = "Japanese Tit"))) %>%
  # adjust Latin names too 
  mutate(latin = str_replace_all(latin, c("Pycnonotus plumosus" = "Pycnonotus sp.","Pycnonotus goiavier" = "Pycnonotus sp.","Pycnonotus aurigaster" = "Pycnonotus sp.","Parus cinereus" = "Parus minor"))) 
  
```

A conservative core estimate (bulbuls kept separate)

```{r}
birds.core.conservative <- birds.adjusted %>%
  # remove flyovers and observations > 70 m [to only include records in core plot]
  subset(distance < 20) %>%
  # remove records of uncertain ID [doubtful records, those marked 'Unidentified', Sunda frogmouth etc had value of 1 in 'uncertain' column]
  subset(uncertain == 0) %>%
  # remove red junglefowl / domestic chicken
  subset(common != "Red Junglefowl") %>%
  #remove Eurasian tree sparrow
  subset(common != "Eurasian Tree Sparrow") %>%
  # remove Oriental Mapgie Robin (poaching pressure biases results)
  subset(common != "Oriental Magpie-robin") %>%
  # remove Sunda Frogmout (nocturnal birds not adequately sampled)
  subset(common != "Sunda Frogmouth")
 
```

A anti-conservative sample, with all birds recorded in plot including the non-core area

```{r}
birds.all.plot <- birds.adjusted %>%
  # remove flyovers and observations > 70 m [to only include records in core plot]
  subset(distance < 75) %>%
  # remove records of uncertain ID [doubtful records, those marked 'Unidentified', Sunda frogmouth etc had value of 1 in 'uncertain' column]
  subset(uncertain == 0) %>%
  # remove red junglefowl / domestic chicken
  subset(common != "Red Junglefowl") %>%
  #remove Eurasian tree sparrow
  subset(common != "Eurasian Tree Sparrow") %>%
  # remove Oriental Mapgie Robin (poaching pressure biases results)
  subset(common != "Oriental Magpie-robin") %>%
  # remove Sunda Frogmout (nocturnal birds not adequately sampled)
  subset(common != "Sunda Frogmouth")
 
```

Visualise change in species richness (core dataset)

```{r}
birds.core %>%
  mutate(stage = fct_relevel(stage, "Before", "After")) %>%
  group_by(round, plot) %>%
  mutate(n = length(common)) %>%
  mutate(sr = n_distinct(common)) %>%
  ggplot() +
  geom_boxplot(aes(x = stage, y = sr, fill = treatment)) +
  scale_fill_manual(values = c("#1b9e77", "#7570b3", "#d95f02")) +
  theme_bw(12) +
  ylim(0,5) +
  facet_wrap(~treatment)  +
  labs( y = "number of species recorded", x = "", title = "")
```
What if we lump bulbuls

```{r}
birds.core.bulbul.lump %>%
  mutate(stage = fct_relevel(stage, "Before", "After")) %>%
  group_by(round, plot) %>%
  mutate(n = length(common)) %>%
  mutate(sr = n_distinct(common)) %>%
  ggplot() +
  geom_boxplot(aes(x = stage, y = sr, fill = treatment)) +
  scale_fill_manual(values = c("#1b9e77", "#7570b3", "#d95f02")) +
  theme_bw(12) +
  ylim(0,5) +
  facet_wrap(~treatment)  +
  labs( y = "number of species recorded", x = "", title = "")
```
No impact of splitting bulbuls - i.e. bulbuls were not erroneously split within the same point count. Overall I think it makes sense to keep them split as 3 species for subsequent analyses. I think the only possible issue is that olive-winged bulbul might be undersampled, which would affect some of the community composition analyses. 

If we restrict to < 20 m from observer:

```{r}
birds.core.conservative %>%
  mutate(stage = fct_relevel(stage, "Before", "After")) %>%
  group_by(round, plot) %>%
  mutate(n = length(common)) %>%
  mutate(sr = n_distinct(common)) %>%
  ggplot() +
  geom_boxplot(aes(x = stage, y = sr, fill = treatment)) +
  scale_fill_manual(values = c("#1b9e77", "#7570b3", "#d95f02")) +
  theme_bw(12) +
  ylim(0,5) +
  facet_wrap(~treatment)  +
  labs( y = "number of species recorded", x = "", title = "")
```
OK that would be too restrictive. I think the core area is fine, and makes sense to restrict analysis to this. 

For visualisation how about if we include all species in the plot, not just core area?

```{r}
birds.all.plot %>%
  mutate(stage = fct_relevel(stage, "Before", "After")) %>%
  group_by(round, plot) %>%
  mutate(n = length(common)) %>%
  mutate(sr = n_distinct(common)) %>%
  ggplot() +
  geom_boxplot(aes(x = stage, y = sr, fill = treatment)) +
  scale_fill_manual(values = c("#1b9e77", "#7570b3", "#d95f02")) +
  theme_bw(12) +
  ylim(0,5) +
  facet_wrap(~treatment)  +
  labs( y = "number of species recorded", x = "", title = "")
```
Interesting pattern for the normal plots! Sensitivity analysis will probably indicate that the pattern we observe only holds for the core area - plausible as birds are very mobile - but let's see. 

Abundance patterns for core area?

```{r}
birds.core %>%
  mutate(stage = fct_relevel(stage, "Before", "After")) %>%
  group_by(round, plot) %>%
  mutate(n = length(common)) %>%
  mutate(sr = n_distinct(common)) %>%
  ggplot() +
  geom_boxplot(aes(x = stage, y = n, fill = treatment)) +
  scale_fill_manual(values = c("#1b9e77", "#7570b3", "#d95f02")) +
  theme_bw(12) +
  ylim(0,8) +
  facet_wrap(~treatment)  +
  labs( y = "number of individuals recorded", x = "", title = "")
```


Abundnace patterns for whole plot?

```{r}
birds.all.plot %>%
  mutate(stage = fct_relevel(stage, "Before", "After")) %>%
  group_by(round, plot) %>%
  mutate(n = length(common)) %>%
  mutate(sr = n_distinct(common)) %>%
  ggplot() +
  geom_boxplot(aes(x = stage, y = n, fill = treatment)) +
  scale_fill_manual(values = c("#1b9e77", "#7570b3", "#d95f02")) +
  theme_bw(12) +
  ylim(0,8) +
  facet_wrap(~treatment)  +
  labs( y = "number of individuals recorded", x = "", title = "")
```

Load vegetation data

```{r}
veg.all <- read_csv("BEFTA_InsectTrapVeg-RReady.csv")
```

```{r}
head(veg.all)
```
subset

```{r}
veg <- veg.all %>%
  filter(TimeBlock == "2013-03" | TimeBlock == "2017-05") %>%
  select(PrePost, TimeBlock, TrapBearing, BEFTAcode, PlotNumber, Treatment, VegHeight, BareGround,
         Fern, Frond, OtherPlants, Densio1, Densio2, Densio3, Densio4, MeanPercentOpen)

head(veg)
```
Need to ask Sarah about the variables, e.g. what is TrapBearing https://www.frontiersin.org/articles/10.3389/ffgc.2019.00033/full

```{r}
veg %>%
  unite("StagePlot", c(PrePost, PlotNumber), sep = "_") %>%
  group_by(StagePlot) %>%
  summarise_at(vars(-TrapBearing), funs(mean(., na.rm=TRUE))) %>%
  str()
```


END